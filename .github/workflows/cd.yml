name: CD
on:
  push:
    branches: [ "main" ]   # Runs only when code is pushed or merged to main

env:
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/hello-cicd

jobs:
  build_push_deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Check out your code from GitHub
      - uses: actions/checkout@v4

      # Step 2: Log in to Docker Hub using secrets youâ€™ll add in GitHub Settings
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Step 3: Create a short version tag from the commit SHA
      - name: Extract version
        id: meta
        run: echo "tag=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      # Step 4: Build and push Docker image
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.tag }}
            ${{ env.IMAGE_NAME }}:latest

      # Step 5: Make sure fly.toml references the latest image
      - name: Ensure image line in fly.toml
        run: |
          sed -i 's|^#*\s*image\s*=.*$|image = "${{ env.IMAGE_NAME }}:latest"|' fly.toml || echo 'image = "${{ env.IMAGE_NAME }}:latest"' >> fly.toml

      # Step 6: Deploy the image to Fly.io
      - name: Deploy with Fly
        uses: superfly/flyctl-actions/setup-flyctl@master
      - run: flyctl deploy --config fly.toml --app "${{ secrets.FLY_APP_NAME }}" --image "${{ env.IMAGE_NAME }}:latest"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
